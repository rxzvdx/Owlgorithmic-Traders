<!--
Author(s): 
    Antonio Rosado
    Kashan Khan
    Imad Khan
    Alexander Schifferle
    Mike Kheang
Assignment: 
    Senior Project (Summer 2025) - "dashboard"
Last Update: 
    June 8 2025
Purpose: 
    Display user dashboard (disclosures, specific representatives, stats by year, filtering) -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Disclosures Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-theme">

  <!-- Back Button Only (removed all nav links) -->
  <div class="top-right-nav">
    <a href="#" class="back-btn" onclick="history.back(); return false;">Back</a>
  </div>

  <!-- Filters Row -->
  <div class="container">
    <h2 style="text-align:center; margin: 20px 0;">Financial Disclosure Filings</h2>
    <div class="filters-row">
      <div class="filter-container">
        <input type="text" id="nameFilter" placeholder="Filter by name..." autocomplete="off">
        <div id="nameSuggestionBox" class="suggestion-box"></div>
      </div>
      <div class="filter-container">
        <input type="text" id="stateFilter" placeholder="Filter by state..." autocomplete="off">
        <div id="stateSuggestionBox" class="suggestion-box"></div>
      </div>
      <div class="filter-container">
        <select id="transactionFilter">
          <option value="">All Transaction Types</option>
        </select>
      </div>
      <div class="filter-container">
        <select id="yearFilter">
          <option value="">All Years</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Disclosure Table -->
  <div class="container">
    <div class="table-container" style="margin-top: 20px;">
      <table id="disclosureTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>State</th>
            <th>Transaction Type</th>
            <th>Filing Date</th>
            <th>Year</th>
          </tr>
        </thead>
        <tbody id="disclosureBody">
          <!-- Populated via JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Debounce helper
    function debounce(fn, delay) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
      };
    }

    // Code â†’ full labels
    const typeMap = {
      'C':'Current Filing','O':'Original Filing',
      'W':'Withdrawn Filing','X':'Exempt Filing',
      'P':'Periodic Filing','A':'Amendment Filing',
      'D':'Deleted Filing','T':'Terminated Filing'
    };
    const stateMap = {
      'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas',
      'CA':'California','CO':'Colorado','CT':'Connecticut','DE':'Delaware',
      'FL':'Florida','GA':'Georgia','HI':'Hawaii','ID':'Idaho',
      'IL':'Illinois','IN':'Indiana','IA':'Iowa','KS':'Kansas',
      'KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
      'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi',
      'MO':'Missouri','MT':'Montana','NE':'Nebraska','NV':'Nevada',
      'NH':'New Hampshire','NJ':'New Jersey','NM':'New Mexico','NY':'New York',
      'NC':'North Carolina','ND':'North Dakota','OH':'Ohio','OK':'Oklahoma',
      'OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
      'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah',
      'VT':'Vermont','VA':'Virginia','WA':'Washington','WV':'West Virginia',
      'WI':'Wisconsin','WY':'Wyoming','DC':'District of Columbia',
      'AS':'American Samoa','AQ':'Antarctica'
    };

    let allData = [], uniqueNames = [], uniqueStates = [], uniqueTrans = [], uniqueYears = [];

    function renderRows(data) {
      const body = document.getElementById('disclosureBody');
      body.innerHTML = '';
      if (!data.length) {
        body.innerHTML = `<tr><td colspan="5">No data available.</td></tr>`;
        return;
      }
      data.forEach(e => {
        const rawType = e.transaction_type ?? e.type ?? '';
        const displayType = typeMap[rawType] || rawType || 'Not Available';
        const abbr = (e.state||'').slice(0,2).toUpperCase();
        const displayState = stateMap[abbr] || abbr;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.name}</td>
          <td>${displayState}</td>
          <td>${displayType}</td>
          <td>${e.date}</td>
          <td>${e.year}</td>
        `;
        body.appendChild(tr);
      });
    }

    function showSuggestions(list, boxId, inputId) {
      const box = document.getElementById(boxId);
      box.innerHTML = '';
      if (!list.length) { box.style.display = 'none'; return; }
      list.slice(0,5).forEach(val => {
        const div = document.createElement('div');
        div.textContent = val;
        div.onclick = () => {
          document.getElementById(inputId).value = val;
          box.style.display = 'none';
          applyFilters();
        };
        box.appendChild(div);
      });
      box.style.display = 'block';
    }

    function applyFilters() {
      const n = document.getElementById('nameFilter').value.toLowerCase();
      const s = document.getElementById('stateFilter').value.toLowerCase();
      const t = document.getElementById('transactionFilter').value;
      const y = document.getElementById('yearFilter').value;
      const filtered = allData.filter(e => {
        const matchName = e.name.toLowerCase().includes(n);
        const abbr = (e.state||'').slice(0,2).toUpperCase();
        const matchState = (stateMap[abbr]||abbr).toLowerCase().includes(s);
        const rawT = e.transaction_type ?? e.type ?? '';
        const displayT = typeMap[rawT]||rawT||'';
        const matchT = !t || displayT === t;
        const matchY = !y || e.year === y;
        return matchName && matchState && matchT && matchY;
      });
      renderRows(filtered);
    }

    document.addEventListener('click', e => {
      if (!e.target.closest('.filter-container')) {
        document.getElementById('nameSuggestionBox').style.display = 'none';
        document.getElementById('stateSuggestionBox').style.display = 'none';
      }
    });

    fetch('/api/disclosures')
      .then(r => r.json())
      .then(data => {
        allData = Array.isArray(data) ? data : [];
        uniqueNames = [...new Set(allData.map(e => e.name))].sort();
        uniqueStates = [...new Set(allData.map(e => {
          const ab = (e.state||'').slice(0,2).toUpperCase();
          return stateMap[ab] || ab;
        }))].sort();
        uniqueTrans = [...new Set(allData.map(e => {
          const rt = e.transaction_type ?? e.type ?? '';
          return typeMap[rt] || rt || '';
        }))].filter(t => t.length > 1).sort();
        uniqueYears = [...new Set(allData.map(e => e.year))].sort();

        renderRows(allData);

        const txSel = document.getElementById('transactionFilter');
        uniqueTrans.forEach(t => {
          const o = document.createElement('option');
          o.value = o.textContent = t;
          txSel.appendChild(o);
        });

        const yrSel = document.getElementById('yearFilter');
        uniqueYears.forEach(y => {
          const o = document.createElement('option');
          o.value = o.textContent = y;
          yrSel.appendChild(o);
        });

        const nameInput  = document.getElementById('nameFilter');
        const stateInput = document.getElementById('stateFilter');

        nameInput.addEventListener('input',
          debounce(() => {
            const v = nameInput.value.toLowerCase();
            showSuggestions(uniqueNames.filter(n => n.toLowerCase().includes(v)),
                            'nameSuggestionBox','nameFilter');
            applyFilters();
          }, 250)
        );
        stateInput.addEventListener('input',
          debounce(() => {
            const v = stateInput.value.toLowerCase();
            showSuggestions(uniqueStates.filter(s => s.toLowerCase().includes(v)),
                            'stateSuggestionBox','stateFilter');
            applyFilters();
          }, 250)
        );
        document.getElementById('transactionFilter').addEventListener('change',
          debounce(applyFilters, 100)
        );
        document.getElementById('yearFilter').addEventListener('change',
          debounce(applyFilters, 100)
        );
      })
      .catch(() => {
        document.getElementById('disclosureBody').innerHTML = `<tr><td colspan="5">Failed to load data.</td></tr>`;
      });
  </script>
</body>
</html>