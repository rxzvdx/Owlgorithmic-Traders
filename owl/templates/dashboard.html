<!--
Author(s): 
    Antonio Rosado
    Kashan Khan
    Imad Khan
    Alexander Schifferle
    Mike Kheang
Assignment: 
    Senior Project (Summer 2025) - "dashboard"
Last Update: 
    June 18 2025
Purpose: 
    Display user dashboard (disclosures, specific representatives, stats by year, filtering)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Disclosures Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* suggestion dropdown styling */
    .suggestion-box {
      position: absolute;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      z-index: 1000;
      max-height: 150px;
      overflow-y: auto;
      width: 200px;
      display: none;
    }
    .suggestion-box .suggestion {
      padding: 8px;
      cursor: pointer;
      background: #000;
      color: #fff;
    }
    .suggestion-box .suggestion:hover {
      background: #fff;
      color: #000;
    }
  </style>
</head>
<body class="dark-theme">

  <!-- NAV BAR -->
  <nav>
    <img src="{{ url_for('static', filename='images/logo.png') }}" class="logo" alt="Logo">
    <ul>
      <li><a href="{{ url_for('index') }}">Home</a></li>
      <li><a href="{{ url_for('chart_list') }}">Live Charts</a></li>
      <li><a href="{{ url_for('contact') }}">Contact</a></li>
      {% if google is defined and google.authorized %}
        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
      {% endif %}
    </ul>
  </nav>

  <!-- Filters Row -->
  <div class="container" style="position: relative;">
    <h2 style="text-align:center; margin:20px 0;">Financial Disclosure Filings</h2>
    <div class="filters-row">
      <div class="filter-container" style="position: relative;">
        <input type="text" id="nameFilter" placeholder="Filter by name..." autocomplete="off">
        <div id="nameSuggestionBox" class="suggestion-box"></div>
      </div>
      <div class="filter-container" style="position: relative;">
        <input type="text" id="stateFilter" placeholder="Filter by state..." autocomplete="off">
        <div id="stateSuggestionBox" class="suggestion-box"></div>
      </div>
      <div class="filter-container">
        <select id="transactionFilter">
          <option value="">All Transaction Types</option>
        </select>
      </div>
      <div class="filter-container">
        <select id="yearFilter">
          <option value="">All Years</option>
        </select>
      </div>
    </div>

    <!-- Disclosure Table -->
    <div class="table-container" style="margin-top:20px;">
      <table id="disclosureTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>State</th>
            <th>Transaction</th>
            <th>Year</th>
            <th>Symbol</th>
          </tr>
        </thead>
        <tbody id="disclosureBody">
          <!-- Populated via JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Mapping state codes to full names
    const stateMapping = {
      AL: 'Alabama', AK: 'Alaska', AZ: 'Arizona', AR: 'Arkansas', CA: 'California',
      CO: 'Colorado', CT: 'Connecticut', DE: 'Delaware', FL: 'Florida', GA: 'Georgia',
      HI: 'Hawaii', ID: 'Idaho', IL: 'Illinois', IN: 'Indiana', IA: 'Iowa',
      KS: 'Kansas', KY: 'Kentucky', LA: 'Louisiana', ME: 'Maine', MD: 'Maryland',
      MA: 'Massachusetts', MI: 'Michigan', MN: 'Minnesota', MS: 'Mississippi',
      MO: 'Missouri', MT: 'Montana', NE: 'Nebraska', NV: 'Nevada',
      NH: 'New Hampshire', NJ: 'New Jersey', NM: 'New Mexico', NY: 'New York',
      NC: 'North Carolina', ND: 'North Dakota', OH: 'Ohio', OK: 'Oklahoma',
      OR: 'Oregon', PA: 'Pennsylvania', RI: 'Rhode Island', SC: 'South Carolina',
      SD: 'South Dakota', TN: 'Tennessee', TX: 'Texas', UT: 'Utah', VT: 'Vermont',
      VA: 'Virginia', WA: 'Washington', WV: 'West Virginia', WI: 'Wisconsin', WY: 'Wyoming',
      DC: 'District of Columbia'
    };

    function debounce(fn, delay) {
      let tid;
      return (...args) => {
        clearTimeout(tid);
        tid = setTimeout(() => fn(...args), delay);
      };
    }

    let allData = [];
    let uniqueNames = [];
    let uniqueStateCodes = [];

    fetch('/api/disclosures')
      .then(r => r.json())
      .then(data => {
        allData = data;
        uniqueNames = [...new Set(data.map(d => d.name))].sort();
        uniqueStateCodes = [
          ...new Set(data.map(d => (d.state.match(/^[A-Za-z]+/) || [''])[0]))
        ].filter(c => c).sort();
        populateFilters(data);
        applyFilters();
      })
      .catch(() => {
        document.getElementById('disclosureBody').innerHTML =
          '<tr><td colspan="5">Failed to load data.</td></tr>';
      });

    function populateFilters(data) {
      // transaction types
      [...new Set(data.map(d => d.transaction_type))].sort().forEach(t => {
        const o = document.createElement('option');
        o.value = o.textContent = t;
        document.getElementById('transactionFilter').appendChild(o);
      });
      // years
      [...new Set(data.map(d => d.year))].sort((a,b) => a-b).forEach(y => {
        const o = document.createElement('option');
        o.value = o.textContent = y;
        document.getElementById('yearFilter').appendChild(o);
      });
      // events
      document.getElementById('nameFilter')
        .addEventListener('input', debounce(handleNameInput, 100));
      document.getElementById('stateFilter')
        .addEventListener('input', debounce(handleStateInput, 100));
      document.getElementById('transactionFilter')
        .addEventListener('change', debounce(applyFilters, 100));
      document.getElementById('yearFilter')
        .addEventListener('change', debounce(applyFilters, 100));

      document.getElementById('nameSuggestionBox')
        .addEventListener('click', e => {
          if (!e.target.matches('.suggestion')) return;
          const box = document.getElementById('nameSuggestionBox');
          document.getElementById('nameFilter').value = e.target.textContent;
          box.innerHTML = '';
          box.style.display = 'none';
          applyFilters();
        });

      document.getElementById('stateSuggestionBox')
        .addEventListener('click', e => {
          if (!e.target.matches('.suggestion')) return;
          const box = document.getElementById('stateSuggestionBox');
          document.getElementById('stateFilter').value = e.target.dataset.code;
          box.innerHTML = '';
          box.style.display = 'none';
          applyFilters();
        });

      // hide suggestion boxes on outside click
      document.addEventListener('click', e => {
        if (!e.target.closest('#nameFilter') && !e.target.closest('#nameSuggestionBox')) {
          document.getElementById('nameSuggestionBox').style.display = 'none';
        }
        if (!e.target.closest('#stateFilter') && !e.target.closest('#stateSuggestionBox')) {
          document.getElementById('stateSuggestionBox').style.display = 'none';
        }
      });
    }

    function handleNameInput(e) {
      const val = e.target.value.toLowerCase();
      const box = document.getElementById('nameSuggestionBox');
      if (!val) {
        box.style.display = 'none';
        box.innerHTML = '';
        applyFilters();
        return;
      }
      const suggestions = uniqueNames.filter(n =>
        n.toLowerCase().includes(val)
      ).slice(0, 5);
      box.style.display = suggestions.length ? 'block' : 'none';
      box.innerHTML = suggestions.map(n =>
        `<div class="suggestion">${n}</div>`
      ).join('');
      applyFilters();
    }

    function handleStateInput(e) {
      const val = e.target.value.toLowerCase();
      const box = document.getElementById('stateSuggestionBox');
      if (!val) {
        box.style.display = 'none';
        box.innerHTML = '';
        applyFilters();
        return;
      }
      const matches = uniqueStateCodes.filter(code => {
        const name = stateMapping[code] || code;
        return code.toLowerCase().includes(val) ||
               name.toLowerCase().includes(val);
      }).slice(0, 5);
      box.style.display = matches.length ? 'block' : 'none';
      box.innerHTML = matches.map(code => {
        const name = stateMapping[code] || code;
        return `<div class="suggestion" data-code="${code}">${name}</div>`;
      }).join('');
      applyFilters();
    }

    function applyFilters() {
      const nameVal = document.getElementById('nameFilter').value.toLowerCase();
      const stateVal = document.getElementById('stateFilter').value;
      const transVal = document.getElementById('transactionFilter').value;
      const yearVal = document.getElementById('yearFilter').value;

      const filtered = allData.filter(d => {
        const code = (d.state.match(/^[A-Za-z]+/) || [''])[0];
        return d.name.toLowerCase().includes(nameVal) &&
               (stateVal === '' || code === stateVal) &&
               (transVal === '' || d.transaction_type === transVal) &&
               (yearVal === '' || d.year.toString() === yearVal);
      });
      renderTable(filtered);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('disclosureBody');
      tbody.innerHTML = '';
      rows.forEach(d => {
        const code = (d.state.match(/^[A-Za-z]+/) || [''])[0];
        const stateName = stateMapping[code] || code;
        const nameButton = `
          <button
            type="button"
            class="rep-button"
            onclick="
              window.location.href =
                '/profile?name=${encodeURIComponent(d.name)}' +
                '&state=${encodeURIComponent(code)}' +
                '&transaction_type=${encodeURIComponent(d.transaction_type)}' +
                '&year=${encodeURIComponent(d.year)}' +
                '&symbol=${encodeURIComponent(d.symbol)}'
            "
          >${d.name}</button>
        `.trim();

        const tr = `<tr>
          <td>${nameButton}</td>
          <td>${stateName}</td>
          <td>${d.transaction_type}</td>
          <td>${d.year}</td>
          <td>${d.symbol}</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', tr);
      });
    }
  </script>
</body>
</html>