<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-theme">

  <!-- NAVBAR -->
  <div id="header">
    <div class="container">
      <nav>
        <img src="{{ url_for('static', filename='images/logo.png') }}" class="logo">
        <ul>
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#services">Services</a></li>
          <li><a href="{{ url_for('contact') }}">Contact</a></li>
          <li><a href="{{ url_for('chart_list') }}">View Live Charts</a></li>
          {% if google.authorized %}
          <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="container">
    <h1>Stock Dashboard</h1>
    <p>Welcome, {{ user_email }}!</p>

    <a href="{{ url_for('disclosures_page') }}" class="btn secondary">View Politician Disclosures</a>

    <div class="page-section">
      <label for="symbol">Enter Stock Symbol (e.g., AAPL):</label>
      <input type="text" id="symbol" placeholder="AAPL" value="AAPL">
      <button onclick="loadData()">Load Data</button>

      <canvas id="stockChart" width="800" height="400" style="margin-top: 20px;"></canvas>
    </div>

    <h2>Your Watchlist</h2>
    <ul id="watchlist"></ul>
    <div>
      <input type="text" id="watchSymbol" placeholder="Add stock (e.g., MSFT)">
      <button onclick="addToWatchlist()">Add</button>
    </div>
  </div>

  <script>
    let chart;
    let watchlist = [];

    function loadData() {
      const symbol = document.getElementById('symbol').value || 'AAPL';
      fetch(`/api/stock/${symbol}`)
        .then(response => response.json())
        .then(data => {
          const labels = data.map(item => item.Date);
          const prices = data.map(item => item.Close);

          if (chart) {
            chart.destroy();
          }

          const ctx = document.getElementById('stockChart').getContext('2d');
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: `${symbol} Stock Price`,
                data: prices,
                borderWidth: 2,
                fill: false,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: 'Date' } },
                y: { title: { display: true, text: 'Price (USD)' } }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching stock data:', error);
          alert('Error fetching stock data. Check stock symbol and try again.');
        });
    }

    function addToWatchlist() {
      const symbol = document.getElementById('watchSymbol').value.toUpperCase();
      if (symbol && !watchlist.includes(symbol)) {
        watchlist.push(symbol);
        updateWatchlist();
      }
    }

    function updateWatchlist() {
      const list = document.getElementById('watchlist');
      list.innerHTML = '';
      watchlist.forEach(symbol => {
        const item = document.createElement('li');
        item.textContent = symbol;
        item.onclick = () => {
          document.getElementById('symbol').value = symbol;
          loadData();
        };
        list.appendChild(item);
      });
    }

    window.onload = loadData;
  </script>

</body>
</html>